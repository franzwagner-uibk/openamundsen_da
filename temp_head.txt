from __future__ import annotations
"""
openamundsen_da.core.config

Purpose
- Build a validated openAMUNDSEN configuration for a single ensemble member by
  layering project/season/step YAML, injecting per‑member paths, normalizing
  important paths to absolute, and returning the parsed OA config object.

Key Behaviors
- Shallow (top‑level) merge with precedence: step > season > project.
- Removes the `environment` block (environment is handled centrally in core.env).
- Injects member-specific `input_data.meteo.dir` and optional `results_dir`.
- Applies CLI‑provided `log_level` so OA’s internal logger uses the same level.
- Writes the merged YAML next to the member for provenance.

Inputs
- Paths to `project.yml`, `season.yml`, and a step YAML (any *.yml in the step).
- Member meteo directory and optional explicit results directory.

Outputs
- Parsed openAMUNDSEN configuration (via openamundsen.conf.parse_config).
"""

from pathlib import Path
from typing import Any, Dict, Optional

from openamundsen.conf import parse_config
from openamundsen.util import read_yaml_file, to_yaml
from openamundsen_da.io.paths import abspath_relative_to
from openamundsen_da.core.constants import (
    INPUT_DATA,
    GRIDS,
    METEO,
    DIR,
    RESULTS_DIR,
    START_DATE,
    END_DATE,
    LOG_LEVEL,
    ENVIRONMENT,
    DA_BLOCK,
)

def merge_configs(
    project_cfg: Dict[str, Any],
    season_cfg: Dict[str, Any],
    step_cfg: Dict[str, Any],
) -> Dict[str, Any]:
    """
    Shallow top‑level merge with precedence: step > season > project.

    Parameters
    - project_cfg: Parsed project YAML as dict
    - season_cfg: Parsed season YAML as dict
    - step_cfg: Parsed step YAML as dict

    Returns
    - merged: dict containing all top‑level keys with later layers overriding
      earlier ones. For nested dicts, the merge is shallow (no deep merge).
    """
    merged: Dict[str, Any] = {}
    keys = set()
    for d in (project_cfg or {}, season_cfg or {}, step_cfg or {}):
        keys.update(d.keys())
    for k in keys:
        p, s, t = (project_cfg or {}).get(k), (season_cfg or {}).get(k), (step_cfg or {}).get(k)
        if isinstance(p, dict) or isinstance(s, dict) or isinstance(t, dict):
            merged[k] = {}
            if isinstance(p, dict): merged[k].update(p)
            if isinstance(s, dict): merged[k].update(s)
            if isinstance(t, dict): merged[k].update(t)
        else:
            merged[k] = t if t is not None else (s if s is not None else p)
    return merged


## moved to openamundsen_da.io.paths.abspath_relative_to

def load_merged_config(
    project_yaml: Path | str,
